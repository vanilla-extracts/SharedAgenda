---
- name: "Install and Configure Postgresql"
  hosts: platform_shag_bdds
  gather_facts: no 
  tasks:
    - name: install prerequisites
      become: true
      apt: name={{ item }} state=latest
      with_items:
        - libpq-dev
        - python3-psycopg2
        - acl
      tags:
        - packages
    - name: "Install postgresql-common package"
      become: true
      ansible.builtin.apt:
        name: postgresql-common
        state: present
    - name: "Install postgresql package"
      become: true
      ansible.builtin.apt:
        name: postgresql
        state: present
    - name: "Set postgresql listen adresses"
      become: true
      become_user: postgres
      community.postgresql.postgresql_set:
        name: listen_addresses
        value: "localhost, {{ vm_bdds_01_data_ip }}"
    - name: Grant remote access for database agenda by user agenda 
      become: true
      become_user: postgres
      community.postgresql.postgresql_pg_hba:
        dest: /etc/postgresql/15/main/pg_hba.conf
        contype: host
        users: agenda
        source: "172.14.0.0/24"
        databases: agenda
        method: scram-sha-256
        create: true
    - name: Create agenda user, password agenda, with CREATEDB and LOGIN as flags
      become: true
      become_user: postgres
      community.postgresql.postgresql_user:
        name: agenda
        password: agenda
        role_attr_flags: createdb,login
        expires: 'infinity'
    - name: Create agenda database owned by agenda role
      become: true
      become_user: postgres
      community.postgresql.postgresql_db:
        name: agenda
        owner: agenda
    - name: "Restart Postgresql"
      become: true
      ansible.builtin.systemd_service:
        name: postgresql
        state: restarted
